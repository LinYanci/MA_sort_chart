<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>SMA/EMA/WMA 暴力破解最佳化系統 - 完整版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { background: #f4f7f9; }
        .sidebar { background: #fff; padding: 20px; min-height: 100vh; border-right: 1px solid #ddd; position: sticky; top: 0; }
        .config-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        #mainChart, #heatmapChart, #surfaceChart3D { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #mainChart { height: 500px; }
        #heatmapChart { height: 500px; }
        #surfaceChart3D { height: 600px; }
        .table-container { border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow-y: auto; }
        .trade-log-height { max-height: 350px; }
        .ranking-height { max-height: 400px; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: #f1f3f5 !important; }
        .active-row { background: #cfe2ff !important; font-weight: bold; }
        .sticky-header thead { position: sticky; top: 0; background: #212529; color: white; z-index: 10; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 sidebar">
            <h4 class="mb-4 text-primary">策略最佳化引擎</h4>
            
            <div class="config-section">
                <label class="form-label fw-bold">1. 數據上傳</label>
                <input type="file" id="csvFile" accept=".csv" class="form-control mb-2" />
                <select id="stockSelect" class="form-select" disabled></select>
            </div>

            <div class="config-section">
                <label class="form-label fw-bold">2. 策略設定</label>
                <small>均線類型</small>
                <select id="maType" class="form-select mb-2">
                    <option value="SMA">SMA (簡單移動平均)</option>
                    <option value="EMA">EMA (指數移動平均)</option>
                    <option value="WMA">WMA (加權移動平均)</option>
                </select>
                <small>搜尋範圍 (天數 1-N)</small>
                <input type="number" id="maxP" class="form-control" value="100">
            </div>

            <div class="config-section">
                <label class="form-label fw-bold">3. 帳戶與規費</label>
                <div class="mb-2">
                    <small>初始資金 (USD)</small>
                    <input type="number" id="initCapitalInput" class="form-control" value="10000">
                </div>
                <div>
                    <small>手續費率 (例如 0.0008)</small>
                    <input type="number" id="commRateInput" class="form-control" value="0.0008" step="0.0001">
                </div>
            </div>

            <div class="config-section">
                <label class="form-label fw-bold">4. 日期篩選</label>
                <div class="mb-2"><small>開始</small><input type="date" id="startDate" class="form-control"></div>
                <div class="mb-2"><small>結束</small><input type="date" id="endDate" class="form-control"></div>
            </div>

            <button id="runBtn" class="btn btn-primary w-100 fw-bold shadow-sm" disabled>開始暴力破解搜尋</button>
            <div id="loader" class="text-center mt-3 d-none">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2 small">計算中...</span>
            </div>
        </nav>

        <main class="col-md-9 p-4">
            <div id="mainChart"></div>

            <div class="row">
                <div class="col-xl-6">
                    <h5 class="mb-2 text-primary border-bottom pb-2">2D 獲利熱力圖</h5>
                    <div id="heatmapChart"></div>
                </div>
                <div class="col-xl-6">
                    <h5 class="mb-2 text-primary border-bottom pb-2">3D 獲利地形圖</h5>
                    <div id="surfaceChart3D"></div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">當前組合交易明細</h5>
                <div id="summaryStats" class="badge bg-dark p-2" style="font-size: 0.9rem;">等待計算</div>
            </div>

            <div class="table-container trade-log-height mb-5 shadow-sm">
                <table class="table table-sm mb-0 sticky-header" id="tradeTable">
                    <thead>
                        <tr><th>序號</th><th>日期</th><th>動作</th><th>價格</th><th>股數</th><th>損益 (USD)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h5 class="mb-2 text-primary border-bottom pb-2">Top 20 最佳參數組合</h5>
            <div class="table-container ranking-height shadow-sm">
                <table class="table table-hover table-sm mb-0 sticky-header" id="rankingTable">
                    <thead class="table-primary text-dark">
                        <tr>
                            <th>排名</th><th>參數(S/L)</th><th>最終資產</th><th>總報酬</th>
                            <th>交易次數</th><th>總獲利</th><th>總虧損</th><th>勝率</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
// --- 全域變數 ---
let fullDates = [];   //所有交易日期
let fullPrices = [];  //選定股票的價格序列
let rawCSVData = [];
let headers = [];   // CSV 欄位名稱（股票代碼）
let allMA = {};   //預先計算的均線快取 { period -> MA array }

// --- 檔案處理 ---
document.getElementById('csvFile').addEventListener('change', function(e) {
    Papa.parse(e.target.files[0], {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: function(results) {
            rawCSVData = results.data;
            headers = Object.keys(rawCSVData[0]);
            fullDates = rawCSVData.map(r => r[headers[0]]);
            const select = document.getElementById('stockSelect');
            select.innerHTML = headers.slice(1).map(h => `<option value="${h}">${h}</option>`).join('');
            select.disabled = false;
            document.getElementById('runBtn').disabled = false;
            document.getElementById('startDate').value = new Date(fullDates[0]).toISOString().split('T')[0];
            document.getElementById('endDate').value = new Date(fullDates[fullDates.length-1]).toISOString().split('T')[0];
        }
    });
});

// --- 均線計算演算法 ---
//SMA
function calcSMA(prices, period) {
    let sma = new Array(prices.length).fill(null);
    let sum = 0;
    for (let i = 0; i < prices.length; i++) {
        sum += (prices[i] || 0);
        if (i >= period) sum -= (prices[i - period] || 0);
        if (i >= period - 1) sma[i] = sum / period;
    }
    return sma;
}
//EMA
function calcEMA(prices, period) {
    let ema = new Array(prices.length).fill(null);
    let alpha = 2 / (period + 1);
    let prev = null;
    for (let i = 0; i < prices.length; i++) {
        if (prices[i] !== null && !isNaN(prices[i])) {
            if (prev === null) { prev = prices[i]; ema[i] = prev; } 
            else { prev = alpha * prices[i] + (1 - alpha) * prev; ema[i] = prev; }
        }
    }
    return ema;
}
//WMA
function calcWMA(prices, period) {
    let wma = new Array(prices.length).fill(null);
    let weightSum = (period * (period + 1)) / 2;
    for (let i = period - 1; i < prices.length; i++) {
        let sum = 0; let valid = true;
        for (let j = 0; j < period; j++) {
            let p = prices[i - period + 1 + j];
            if (p === null || isNaN(p)) { valid = false; break; }
            sum += p * (j + 1);
        }
        if (valid) wma[i] = sum / weightSum;
    }
    return wma;
}

// --- 核心回測引擎 ---
function runBacktest(startIdx, endIdx, s, l, initCap, commRate) {
    let cash = initCap;
    let shares = 0;
    let firstBuyTotalCost = 0;
    let hasPosition = false;
    let tradeCount = 0;
    let winCount = 0;
    let lossCount = 0;
    let totalProfit = 0;
    let totalLoss = 0;
    let goldenCount = 0;
    let deathCount = 0;
    let maxValue = initCap;
    let maxDD = 0;
    let tradeLog = [];
    let equityCurve = [];
    
    const maS = allMA[s];
    const maL = allMA[l];

    for (let i = startIdx; i <= endIdx; i++) {
        const price = fullPrices[i];
        if (isNaN(price)) { 
            equityCurve.push(equityCurve.length > 0 ? equityCurve[equityCurve.length-1] : cash); 
            continue; 
        }

        let currentValue = cash + (shares * price);
        if (currentValue > maxValue) maxValue = currentValue;
        let dd = (maxValue - currentValue) / maxValue * 100;
        if (dd > maxDD) maxDD = dd;

        if (i > 0 && maS[i] && maL[i] && maS[i-1] && maL[i-1]) {
            // 黃金交叉買入 (需扣手續費)
            if (maS[i-1] < maL[i-1] && maS[i] >= maL[i] && !hasPosition) {
                const buyPriceWithFee = price * (1 + commRate);
                shares = Math.floor(cash / buyPriceWithFee);
                if (shares > 0) {
                    goldenCount++;
                    firstBuyTotalCost = shares * buyPriceWithFee;
                    cash -= firstBuyTotalCost;
                    hasPosition = true;
                    tradeCount++;
                    tradeLog.push({ date: fullDates[i], action: 'BUY', price: price, shares: shares, profit: '-' });
                }
            } 
            // 死亡交叉賣出 (需扣手續費)
            else if (maS[i-1] > maL[i-1] && maS[i] <= maL[i] && hasPosition) {
                deathCount++;
                const sellProceedsAfterFee = (shares * price) * (1 - commRate);
                let pnl = sellProceedsAfterFee - firstBuyTotalCost;
                
                if (pnl > 0) { winCount++; totalProfit += pnl; } 
                else if (pnl < 0) { lossCount++; totalLoss += Math.abs(pnl); }
                
                cash += sellProceedsAfterFee;
                tradeLog.push({ date: fullDates[i], action: 'SELL', price: price, shares: shares, profit: pnl.toFixed(2) });
                shares = 0; hasPosition = false; tradeCount++;
            }
        }
        equityCurve.push(cash + (shares * price));
    }

    // 期末清倉
    if (hasPosition) {
        deathCount++;
        const lastPrice = fullPrices[endIdx];
        const sellProceedsAfterFee = (shares * lastPrice) * (1 - commRate);
        let pnl = sellProceedsAfterFee - firstBuyTotalCost;
        if (pnl > 0) { winCount++; totalProfit += pnl; } 
        else if (pnl < 0) { lossCount++; totalLoss += Math.abs(pnl); }
        cash += sellProceedsAfterFee;
        tradeCount++;
        tradeLog.push({ date: fullDates[endIdx], action: 'CLEAR', price: lastPrice, shares: shares, profit: pnl.toFixed(2) });
    }

    return { s, l, finalValue: cash, tradeCount, winCount, lossCount, totalProfit, totalLoss, goldenCount, deathCount, maxDD, roi: (cash - initCap) / initCap * 100, trades: tradeLog, equity: equityCurve };
}

// --- 執行搜尋主程序 ---
document.getElementById('runBtn').addEventListener('click', function() {
    document.getElementById('loader').classList.remove('d-none');
    
    const stockName = document.getElementById('stockSelect').value;
    const maType = document.getElementById('maType').value;
    const maxP = parseInt(document.getElementById('maxP').value);
    const startD = new Date(document.getElementById('startDate').value);
    const endD = new Date(document.getElementById('endDate').value);
    const initCap = parseFloat(document.getElementById('initCapitalInput').value);
    const commRate = parseFloat(document.getElementById('commRateInput').value);

    setTimeout(() => {
        fullPrices = rawCSVData.map(r => r[stockName]);
        
        // 1. 預計算均線
        allMA = {};
        for (let p = 1; p <= maxP; p++) {
            if (maType === "SMA") allMA[p] = calcSMA(fullPrices, p);
            else if (maType === "EMA") allMA[p] = calcEMA(fullPrices, p);
            else allMA[p] = calcWMA(fullPrices, p);
        }

        let startIdx = -1, endIdx = -1;
        for (let i = 0; i < fullDates.length; i++) {
            let d = new Date(fullDates[i]);
            if (startIdx === -1 && d >= startD) startIdx = i;
            if (d <= endD) endIdx = i;
        }

        // 2. 暴力搜尋
        let results = [];
        let zData = Array.from({ length: maxP }, () => Array(maxP).fill(null));

        for (let s = 1; s <= maxP; s++) {
            for (let l = 1; l <= maxP; l++) {
                const res = runBacktest(startIdx, endIdx, s, l, initCap, commRate);
                results.push(res);
                zData[l - 1][s - 1] = res.roi;
            }
        }

        // 3. 排序 (資產 > 間距 > 短軸)
        results.sort((a, b) => {
            if (Math.abs(a.finalValue - b.finalValue) > 1e-11) return b.finalValue - a.finalValue;
            let distA = Math.abs(a.s - a.l); let distB = Math.abs(b.s - b.l);
            if (distA !== distB) return distB - distA;
            return b.s - a.s;
        });

        // 4. 繪製圖表與渲染介面
        drawHeatmap(zData, maxP);
        drawSurface3D(zData, maxP);
        renderRanking(results.slice(0, 20), startIdx, endIdx);
        updateDisplay(results[0], startIdx, endIdx);
        document.getElementById('loader').classList.add('d-none');
    }, 100);
});

// --- UI 輔助函式 ---

//2D
function drawHeatmap(zData, maxP) {
    const vals = Array.from({ length: maxP }, (_, i) => i + 1);
    Plotly.newPlot('heatmapChart', [{
        z: zData, x: vals, y: vals, type: 'heatmap', colorscale: 'Portland',
        colorbar: { title: 'ROI %' },
        hovertemplate: 'S: %{x}<br>L: %{y}<br>ROI: %{z:.2f}%<extra></extra>'
    }], { title: '2D 獲利熱力圖', xaxis: {title: '短期均線'}, yaxis: {title: '長期均線'} });
}

//3D
function drawSurface3D(zData, maxP) {
    const vals = Array.from({ length: maxP }, (_, i) => i + 1);
    Plotly.newPlot('surfaceChart3D', [{
        z: zData, x: vals, y: vals, type: 'surface', colorscale: 'Portland',
        contours: { z: { show: true, usecolormap: true, project: { z: true } } }
    }], {
        title: '3D 獲利地形圖',
        scene: { xaxis: {title: 'S'}, yaxis: {title: 'L'}, zaxis: {title: 'ROI %'} },
        margin: { l: 0, r: 0, b: 0, t: 50 }
    });
}

function renderRanking(data, sIdx, eIdx) {
    const tbody = document.querySelector('#rankingTable tbody');
    tbody.innerHTML = data.map((r, i) => {
        let winRate = (r.winCount + r.lossCount) > 0 ? ((r.winCount / (r.winCount + r.lossCount)) * 100).toFixed(1) : 0;
        return `
        <tr class="clickable-row ${i===0?'active-row':''}" onclick="selectRank(this, ${JSON.stringify(r).replace(/"/g, '&quot;')}, ${sIdx}, ${eIdx})">
            <td>${i+1}</td><td>${r.s} / ${r.l}</td><td>$${r.finalValue.toFixed(2)}</td>
            <td class="${r.roi >= 0 ? 'text-success' : 'text-danger'}">${r.roi.toFixed(2)}%</td>
            <td>${r.tradeCount}</td><td class="text-success">$${r.totalProfit.toFixed(1)}</td>
            <td class="text-danger">$${r.totalLoss.toFixed(1)}</td><td>${winRate}%</td>
        </tr>`}).join('');
}

function selectRank(row, data, sIdx, eIdx) {
    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active-row'));
    row.classList.add('active-row');
    updateDisplay(data, sIdx, eIdx);
}

function updateDisplay(data, sIdx, eIdx) {
    const dates = fullDates.slice(sIdx, eIdx + 1);
    const prices = fullPrices.slice(sIdx, eIdx + 1);
    const subMaS = allMA[data.s].slice(sIdx, eIdx + 1);
    const subMaL = allMA[data.l].slice(sIdx, eIdx + 1);
    const buySignals = data.trades.filter(t => t.action === 'BUY');
    const sellSignals = data.trades.filter(t => t.action === 'SELL' || t.action === 'CLEAR');
    
    const traces = [
        { x: dates, y: prices, name: '價格', line: {color: '#ccc', width: 1}, yaxis: 'y1' },
        { x: dates, y: subMaS, name: 'Short MA', line: {color: '#f54290'}, yaxis: 'y1' },
        { x: dates, y: subMaL, name: 'Long MA', line: {color: '#f5cb42'}, yaxis: 'y1' },
        { x: buySignals.map(t=>t.date), y: buySignals.map(t=>t.price), mode: 'markers', name: '買入', marker: {symbol:'triangle-up', size:12, color:'#28a745'}, yaxis:'y1' },
        { x: sellSignals.map(t=>t.date), y: sellSignals.map(t=>t.price), mode: 'markers', name: '賣出/清倉', marker: {symbol:'triangle-down', size:12, color:'#dc3545'}, yaxis:'y1' },
        { x: dates, y: data.equity, name: '資產曲線', fill: 'tozeroy', line: {color: '#4caf50'}, yaxis: 'y2' }
    ];

    Plotly.newPlot('mainChart', traces, {
        title: `回測結果：S(${data.s}) / L(${data.l})`,
        yaxis: { domain: [0.35, 1], title: '價格 (USD)' },
        yaxis2: { domain: [0, 0.25], title: '帳戶資產', side: 'right' },
        hovermode: 'x unified', margin: { t: 50, b: 30 }
    });

    // 更新底部統計欄
    document.getElementById('summaryStats').innerHTML = `
        獲利: <span class="text-success">$${data.totalProfit.toFixed(1)}</span> | 
        虧損: <span class="text-danger">$${data.totalLoss.toFixed(1)}</span> | 
        最終資產: $${data.finalValue.toFixed(2)} | 
        <span class="badge bg-success">黃金交叉: ${data.goldenCount} 次</span> | 
        <span class="badge bg-danger">死亡交叉: ${data.deathCount} 次</span>
    `;
    
    const tbody = document.querySelector('#tradeTable tbody');
    tbody.innerHTML = data.trades.map((t, i) => {
        let label = t.action === 'BUY' ? '買入' : (t.action === 'CLEAR' ? '期末清倉' : '賣出');
        return `<tr style="color: ${t.action === 'BUY' ? '#28a745' : '#dc3545'}"><td>${i+1}</td><td>${t.date}</td><td>${label}</td><td>$${t.price.toFixed(2)}</td><td>${t.shares}</td><td>${t.profit >= 0 ? '+' + t.profit : t.profit}</td></tr>`;
    }).reverse().join('');
}
</script>
</body>
</html>