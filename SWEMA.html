<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>SMA/EMA/WMA æš´åŠ›ç ´è§£æœ€ä½³åŒ–ç³»çµ± - æ’åºä¿®æ­£ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f4f7f9; }
        .sidebar { background: #fff; padding: 20px; min-height: 100vh; border-right: 1px solid #ddd; position: sticky; top: 0; }
        .config-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        #mainChart, #heatmapChart, #surfaceChart3D { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #mainChart { height: 500px; }
        #heatmapChart { height: 500px; }
        #surfaceChart3D { height: 600px; }
        .table-container { border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow-y: auto; }
        .trade-log-height { max-height: 350px; }
        .ranking-height { max-height: 400px; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: #f1f3f5 !important; }
        .active-row { background: #cfe2ff !important; font-weight: bold; }
        .sticky-header thead { position: sticky; top: 0; background: #212529; color: white; z-index: 10; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 sidebar">
            <h4 class="mb-4 text-primary">ç­–ç•¥æœ€ä½³åŒ–å¼•æ“</h4>
            
            <div class="config-section">
                <label class="form-label fw-bold">1. æ•¸æ“šä¸Šå‚³</label>
                <input type="file" id="csvFile" accept=".csv" class="form-control mb-2" />
                <select id="stockSelect" class="form-select" disabled></select>
            </div>

            <div class="config-section">
                <label class="form-label fw-bold">2. ç­–ç•¥è¨­å®š</label>
                <small>å‡ç·šé¡å‹</small>
                <select id="maType" class="form-select mb-2">
                    <option value="SMA">SMA (ç°¡å–®ç§»å‹•å¹³å‡)</option>
                    <option value="EMA">EMA (æŒ‡æ•¸ç§»å‹•å¹³å‡)</option>
                    <option value="WMA">WMA (åŠ æ¬Šç§»å‹•å¹³å‡)</option>
                </select>
                <small>æœå°‹ç¯„åœ (å¤©æ•¸ 1-N)</small>
                <input type="number" id="maxP" class="form-control" value="100">
            </div>

            <div class="config-section">
                <label class="form-label fw-bold">3. å¸³æˆ¶èˆ‡è¦è²»</label>
                <div class="mb-2">
                    <small>åˆå§‹è³‡é‡‘ (USD)</small>
                    <input type="number" id="initCapitalInput" class="form-control" value="10000">
                </div>
                <div>
                    <small>æ‰‹çºŒè²»ç‡ (ä¾‹å¦‚ 0.0008)</small>
                    <input type="number" id="commRateInput" class="form-control" value="0.0008" step="0.0001">
                </div>
            </div>

            <div class="config-section">
                <label class="form-label fw-bold">4. æ—¥æœŸç¯©é¸</label>
                <div class="mb-2"><small>é–‹å§‹</small><input type="date" id="startDate" class="form-control"></div>
                <div class="mb-2"><small>çµæŸ</small><input type="date" id="endDate" class="form-control"></div>
                <button id="runBtn" class="btn btn-primary w-100 fw-bold shadow-sm mt-2" disabled>é–‹å§‹æš´åŠ›ç ´è§£æœå°‹</button>
            </div>

            <div class="config-section border border-warning" style="border-width: 2px !important; background: #fffcf5;">
                <label class="form-label fw-bold text-dark">5. è·¨å¹´åº¦é–å®šè¿½è¹¤</label>
                <div id="lockStatusDisplay" class="badge bg-secondary w-100 p-2 mb-2">æœªé–å®šåƒæ•¸</div>
                
                <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text bg-dark text-white">S</span>
                    <input type="number" id="manualS" class="form-control" placeholder="çŸ­æœŸ">
                    <span class="input-group-text bg-dark text-white">L</span>
                    <input type="number" id="manualL" class="form-control" placeholder="é•·æœŸ">
                    <button id="manualApplyBtn" class="btn btn-dark">æŸ¥çœ‹</button>
                </div>
                <small class="text-muted d-block mb-2">*é»æ“ŠæŸ¥çœ‹å¾ŒæŒ‰ F12 å¯çœ‹è©³ç´°é©—ç®—</small>

                <div class="d-flex gap-2 mb-2">
                    <input type="number" id="quickYearInput" class="form-control" value="2014">
                    <button id="setYearBtn" class="btn btn-outline-secondary btn-sm">è¨­å®šæ—¥æœŸ</button>
                </div>
                <button id="runLocateBtn" class="btn btn-warning w-100 fw-bold shadow-sm">åˆ†ææ­¤å¹´ä¸¦å®šä½æ’å</button>
            </div>

            <div id="loader" class="text-center mt-3 d-none">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2 small">æ·±åº¦é‹ç®—æ’åä¸­...</span>
            </div>
        </nav>

        <main class="col-md-9 p-4">
            <h5 class="text-warning border-bottom pb-2">è·¨å¹´åº¦é©—è­‰ç´€éŒ„ (é–å®šçµ„åˆï¼š<span id="lockedParamText">-/-</span>)</h5>
            <div class="table-container mb-4 shadow-sm" style="max-height: 200px; border: 2px solid #ffc107;">
                <table class="table table-sm table-dark mb-0" id="performanceLogTable">
                    <thead>
                        <tr>
                            <th>å¹´åº¦</th><th>åƒæ•¸</th><th>ç•¶å¹´åº¦æ’å</th><th>ROI %</th><th>æœ€çµ‚è³‡ç”¢</th><th>äº¤æ˜“æ¬¡æ•¸</th><th>å‹ç‡</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="mainChart"></div>

            <div class="row">
                <div class="col-xl-6">
                    <h5 class="mb-2 text-primary border-bottom pb-2">2D ç²åˆ©ç†±åŠ›åœ–</h5>
                    <div id="heatmapChart"></div>
                </div>
                <div class="col-xl-6">
                    <h5 class="mb-2 text-primary border-bottom pb-2">3D ç²åˆ©åœ°å½¢åœ–</h5>
                    <div id="surfaceChart3D"></div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">ç•¶å‰çµ„åˆäº¤æ˜“æ˜ç´°</h5>
                <div id="summaryStats" class="badge bg-dark p-2" style="font-size: 0.9rem;">ç­‰å¾…è¨ˆç®—</div>
            </div>

            <div class="table-container trade-log-height mb-5 shadow-sm">
                <table class="table table-sm mb-0 sticky-header" id="tradeTable">
                    <thead>
                        <tr><th>åºè™Ÿ</th><th>æ—¥æœŸ</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th><th>æç›Š (USD)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0 text-primary border-bottom pb-2">Top 20 æœ€ä½³åƒæ•¸çµ„åˆ</h5>
                <button id="exportExcelBtn" class="btn btn-success btn-sm" disabled>
                    ğŸ“Š åŒ¯å‡ºå…¨éƒ¨Excel
                </button>
            </div>
            <div class="table-container ranking-height shadow-sm">
                <table class="table table-hover table-sm mb-0 sticky-header" id="rankingTable">
                    <thead class="table-primary text-dark">
                        <tr>
                            <th>æ’å</th><th>åƒæ•¸(S/L)</th><th>æœ€çµ‚è³‡ç”¢</th><th>ç¸½å ±é…¬</th>
                            <th>äº¤æ˜“æ¬¡æ•¸</th><th>ç¸½ç²åˆ©</th><th>ç¸½è™§æ</th><th>å‹ç‡</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
let fullDates = [];
let fullPrices = [];
let rawCSVData = [];
let headers = [];
let allMA = {};
let lockedS = null;
let lockedL = null;
let currentResults = [];

function toDateKey(value) {
    if (value === null || value === undefined) return '';
    if (typeof value === 'string') {
        const trimmed = value.trim();
        const head = trimmed.slice(0, 10);
        const mh = head.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
        if (mh) {
            const y = mh[1];
            const mo = String(mh[2]).padStart(2, '0');
            const d = String(mh[3]).padStart(2, '0');
            return `${y}-${mo}-${d}`;
        }
        const m = trimmed.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
        if (m) {
            const y = m[1];
            const mo = String(m[2]).padStart(2, '0');
            const d = String(m[3]).padStart(2, '0');
            return `${y}-${mo}-${d}`;
        }
    }
    const d = new Date(value);
    if (isNaN(d)) return '';
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

document.getElementById('csvFile').addEventListener('change', function(e) {
    Papa.parse(e.target.files[0], {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: function(results) {
            rawCSVData = results.data;
            headers = Object.keys(rawCSVData[0]);
            fullDates = rawCSVData.map(r => r[headers[0]]);
            const select = document.getElementById('stockSelect');
            select.innerHTML = headers.slice(1).map(h => `<option value="${h}">${h}</option>`).join('');
            select.disabled = false;
            document.getElementById('runBtn').disabled = false;
            document.getElementById('startDate').value = toDateKey(fullDates[0]);
            document.getElementById('endDate').value = toDateKey(fullDates[fullDates.length-1]);
        }
    });
});

function calcSMA(prices, period) {
    let sma = new Array(prices.length).fill(null);
    let sum = 0;
    for (let i = 0; i < prices.length; i++) {
        sum += (prices[i] || 0);
        if (i >= period) sum -= (prices[i - period] || 0);
        if (i >= period - 1) sma[i] = sum / period;
    }
    return sma;
}
function calcEMA(prices, period) {
    let ema = new Array(prices.length).fill(null);
    let alpha = 2 / (period + 1);
    let prev = null;
    for (let i = 0; i < prices.length; i++) {
        if (prices[i] !== null && !isNaN(prices[i])) {
            if (prev === null) { prev = prices[i]; ema[i] = prev; } 
            else { prev = alpha * prices[i] + (1 - alpha) * prev; ema[i] = prev; }
        }
    }
    return ema;
}
function calcWMA(prices, period) {
    let wma = new Array(prices.length).fill(null);
    let weightSum = (period * (period + 1)) / 2;
    for (let i = period - 1; i < prices.length; i++) {
        let sum = 0; let valid = true;
        for (let j = 0; j < period; j++) {
            let p = prices[i - period + 1 + j];
            if (p === null || isNaN(p)) { valid = false; break; }
            sum += p * (j + 1);
        }
        if (valid) wma[i] = sum / weightSum;
    }
    return wma;
}

function runBacktest(startIdx, endIdx, s, l, initCap, commRate) {
    if (s === l) {
        return { s, l, finalValue: initCap, tradeCount: 0, winCount: 0, lossCount: 0,
                 totalProfit: 0, totalLoss: 0, goldenCount: 0, deathCount: 0,
                 roi: 0, trades: [], equity: new Array(endIdx - startIdx + 2).fill(initCap) };
    }
    
    let cash = initCap, shares = 0, firstBuyTotalCost = 0, hasPosition = false;
    let tradeCount = 0, winCount = 0, lossCount = 0;
    let totalProfit = 0, totalLoss = 0, goldenCount = 0, deathCount = 0;
    let tradeLog = [], equityCurve = [];
    
    const maS = allMA[s], maL = allMA[l];

    for (let i = startIdx; i < endIdx; i++) {  
        const price = fullPrices[i];
        if (isNaN(price)) { 
            equityCurve.push(equityCurve.length > 0 ? equityCurve[equityCurve.length-1] : cash); 
            continue; 
        }
        if (i > startIdx && maS[i] !== null && maL[i] !== null && maS[i - 1] !== null && maL[i - 1] !== null) {
            const prevS = maS[i - 1];
            const prevL = maL[i - 1];
            const currS = maS[i];
            const currL = maL[i];

            // â˜…â˜…â˜… é»ƒé‡‘äº¤å‰ï¼šå‰ä¸€å¤© S <= Lï¼Œç•¶å¤© S > L â˜…â˜…â˜…
            if (prevS <= prevL && currS > currL) {
                if (!hasPosition) {
                    const buyPriceWithFee = price * (1 + commRate);
                    shares = Math.floor(cash / buyPriceWithFee);
                    if (shares > 0) {
                        goldenCount++;
                        firstBuyTotalCost = shares * buyPriceWithFee;
                        cash -= firstBuyTotalCost;
                        hasPosition = true;
                        tradeCount++;
                        tradeLog.push({ date: fullDates[i], action: 'BUY', price, shares, profit: '-' });
                    }
                }
            } 
            // â˜…â˜…â˜… æ­»äº¡äº¤å‰ï¼šå‰ä¸€å¤© S >= Lï¼Œç•¶å¤© S < L â˜…â˜…â˜…
            else if (prevS >= prevL && currS < currL) {
                if (hasPosition) {
                    deathCount++;
                    const sellProceedsAfterFee = (shares * price) * (1 - commRate);
                    let pnl = sellProceedsAfterFee - firstBuyTotalCost;
                    
                    if (pnl > 0.0001) { winCount++; totalProfit += pnl; } 
                    else if (pnl < -0.0001) { lossCount++; totalLoss += Math.abs(pnl); }
                    
                    cash += sellProceedsAfterFee;
                    tradeLog.push({ date: fullDates[i], action: 'SELL', price, shares, profit: pnl.toFixed(2) });
                    shares = 0;
                    hasPosition = false;
                    tradeCount++;
                }
            }
        }
        equityCurve.push(cash + (shares * price));
    }
    
    if (hasPosition === true) { 
        const lastPrice = fullPrices[endIdx];
        const sellProceedsAfterFee = (shares * lastPrice) * (1 - commRate);
        let pnl = sellProceedsAfterFee - firstBuyTotalCost;

        if (pnl > 0.0001) winCount++;
        else if (pnl < -0.0001) lossCount++;

        cash += sellProceedsAfterFee;
        tradeCount++;
        
        tradeLog.push({
            date: fullDates[endIdx],
            action: 'CLEAR',
            price: lastPrice,
            shares: shares,
            profit: pnl.toFixed(2)
        });

        hasPosition = false;
        shares = 0;
    }
    
    equityCurve.push(cash);
    
    return { s, l, finalValue: cash, tradeCount, winCount, lossCount, 
             totalProfit, totalLoss, goldenCount, deathCount, 
             roi: ((cash - initCap) / initCap) * 100, trades: tradeLog, equity: equityCurve };
}

// â˜…â˜…â˜… æ­£ç¢ºæ’åºï¼šfinalValue â†’ é–“è· â†’ S â†’ L â˜…â˜…â˜…
function customSort(a, b) {
    // 1. finalValue å¤§è€…å„ªå…ˆ
    if (b.finalValue !== a.finalValue) {
        return b.finalValue - a.finalValue;
    }
    // 2. é–“è·ï¼ˆ|L-S|ï¼‰å¤§è€…å„ªå…ˆ
    const gapA = Math.abs(a.l - a.s);
    const gapB = Math.abs(b.l - b.s);
    if (gapB !== gapA) {
        return gapB - gapA;
    }
    // 3. S å°è€…å„ªå…ˆ
    if (a.s !== b.s) {
        return a.s - b.s;
    }
    // 4. L å¤§è€…å„ªå…ˆ
    return b.l - a.l;
}

document.getElementById('runBtn').addEventListener('click', function() {
    document.getElementById('loader').classList.remove('d-none');
    const stockName = document.getElementById('stockSelect').value;
    const maType = document.getElementById('maType').value;
    const maxP = parseInt(document.getElementById('maxP').value);
    const startKey = toDateKey(document.getElementById('startDate').value);
    const endKey = toDateKey(document.getElementById('endDate').value);
    const initCap = parseFloat(document.getElementById('initCapitalInput').value), commRate = parseFloat(document.getElementById('commRateInput').value);

    setTimeout(() => {
        fullPrices = rawCSVData.map(r => r[stockName]);
        allMA = {};
        for (let p = 1; p <= maxP; p++) {
            if (maType === "SMA") allMA[p] = calcSMA(fullPrices, p);
            else if (maType === "EMA") allMA[p] = calcEMA(fullPrices, p);
            else allMA[p] = calcWMA(fullPrices, p);
        }
        let startIdx = -1, endIdx = -1;
        for (let i = 0; i < fullDates.length; i++) {
            const key = toDateKey(fullDates[i]);
            if (startIdx === -1 && key >= startKey) startIdx = i;
            if (key <= endKey) endIdx = i;
        }
        let results = [];
        let zData = Array.from({ length: maxP }, () => Array(maxP).fill(null));
        for (let s = 1; s <= maxP; s++) {
            for (let l = 1; l <= maxP; l++) {
                const res = runBacktest(startIdx, endIdx, s, l, initCap, commRate);
                results.push(res);
                zData[l - 1][s - 1] = res.roi;
            }
        }
        
        results.sort(customSort);
        currentResults = results;
        
        drawHeatmap(zData, maxP); drawSurface3D(zData, maxP);
        renderRanking(results.slice(0, 20), startIdx, endIdx);
        updateDisplay(results[0], startIdx, endIdx);
        document.getElementById('exportExcelBtn').disabled = false;
        document.getElementById('loader').classList.add('d-none');
    }, 100);
});

function drawHeatmap(zData, maxP) {
    const vals = Array.from({ length: maxP }, (_, i) => i + 1);
    Plotly.newPlot('heatmapChart', [{ z: zData, x: vals, y: vals, type: 'heatmap', colorscale: 'Portland', colorbar: { title: 'ROI %' } }], { title: '2D ç²åˆ©ç†±åŠ›åœ–' });
}
function drawSurface3D(zData, maxP) {
    const vals = Array.from({ length: maxP }, (_, i) => i + 1);
    Plotly.newPlot('surfaceChart3D', [{ z: zData, x: vals, y: vals, type: 'surface', colorscale: 'Portland' }], { title: '3D ç²åˆ©åœ°å½¢åœ–', margin: { l: 0, r: 0, b: 0, t: 50 } });
}
function renderRanking(data, sIdx, eIdx) {
    const tbody = document.querySelector('#rankingTable tbody');
    tbody.innerHTML = data.map((r, i) => {
        let winRate = ((r.winCount / (r.winCount + r.lossCount || 1)) * 100).toFixed(1);
        return `<tr class="clickable-row ${i===0?'active-row':''}" onclick="selectRank(this, ${JSON.stringify(r).replace(/"/g, '&quot;')}, ${sIdx}, ${eIdx})">
            <td>${i+1}</td><td>${r.s} / ${r.l}</td><td>$${r.finalValue.toFixed(2)}</td><td>${r.roi.toFixed(2)}%</td><td>${r.tradeCount}</td><td>$${r.totalProfit.toFixed(1)}</td><td>$${r.totalLoss.toFixed(1)}</td><td>${winRate}%</td></tr>`}).join('');
}
function selectRank(row, data, sIdx, eIdx) {
    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active-row'));
    if (row) row.classList.add('active-row');
    lockedS = data.s; lockedL = data.l;
    document.getElementById('lockStatusDisplay').innerText = `å·²é–å®šï¼šS(${lockedS}) / L(${lockedL})`;
    document.getElementById('lockStatusDisplay').classList.replace('bg-secondary', 'bg-danger');
    document.getElementById('lockedParamText').innerText = `${lockedS} / ${lockedL}`;
    updateDisplay(data, sIdx, eIdx);
}
function updateDisplay(data, sIdx, eIdx) {
    const dates = fullDates.slice(sIdx, eIdx + 1), prices = fullPrices.slice(sIdx, eIdx + 1);
    const buy = data.trades.filter(t => t.action === 'BUY'), sell = data.trades.filter(t => t.action !== 'BUY');
    
    let traces;
    if (data.s === data.l) {
        traces = [
            { x: dates, y: prices, name: 'åƒ¹æ ¼', line: {color: '#888', width: 2}, yaxis: 'y1' },
            { x: dates, y: allMA[data.s].slice(sIdx, eIdx + 1), name: `MA(${data.s})`, line: {color: '#ff9800', width: 2, dash: 'dot'}, yaxis: 'y1' },
            { x: dates, y: data.equity, name: 'è³‡ç”¢ (ç„¡äº¤æ˜“)', fill: 'tozeroy', line: {color: '#9e9e9e'}, yaxis: 'y2' }
        ];
    } else {
        traces = [
            { x: dates, y: prices, name: 'åƒ¹æ ¼', line: {color: '#ccc', width: 1}, yaxis: 'y1' },
            { x: dates, y: allMA[data.s].slice(sIdx, eIdx + 1), name: `S(${data.s})`, line: {color: '#f54290'}, yaxis: 'y1' },
            { x: dates, y: allMA[data.l].slice(sIdx, eIdx + 1), name: `L(${data.l})`, line: {color: '#f5cb42'}, yaxis: 'y1' },
            { x: buy.map(t=>t.date), y: buy.map(t=>t.price), mode: 'markers', name: 'è²·', marker: {symbol:'triangle-up', size:12, color:'#28a745'} },
            { x: sell.map(t=>t.date), y: sell.map(t=>t.price), mode: 'markers', name: 'è³£', marker: {symbol:'triangle-down', size:12, color:'#dc3545'} },
            { x: dates, y: data.equity, name: 'è³‡ç”¢', fill: 'tozeroy', line: {color: '#4caf50'}, yaxis: 'y2' }
        ];
    }
    
    const titleSuffix = data.s === data.l ? ' (ç„¡äº¤æ˜“æ¨¡å¼)' : '';
    Plotly.newPlot('mainChart', traces, { 
        title: `åˆ†æä¸­ï¼šS(${data.s}) / L(${data.l})${titleSuffix}`, 
        yaxis: { domain: [0.35, 1] }, 
        yaxis2: { domain: [0, 0.25], side: 'right' }, 
        hovermode: 'x unified' 
    });
    
    document.getElementById('summaryStats').innerHTML = `è³‡ç”¢: $${data.finalValue.toFixed(2)} | ç²åˆ©: $${data.totalProfit.toFixed(1)} | äº¤å‰: ${data.goldenCount}/${data.deathCount}`;
    
    if (data.trades.length === 0) {
        document.querySelector('#tradeTable tbody').innerHTML = '<tr><td colspan="6" class="text-center text-muted">ç„¡äº¤æ˜“è¨˜éŒ„ï¼ˆS èˆ‡ L åƒæ•¸ç›¸åŒï¼‰</td></tr>';
    } else {
        document.querySelector('#tradeTable tbody').innerHTML = data.trades.map((t, i) => `<tr><td>${i+1}</td><td>${t.date}</td><td>${t.action}</td><td>$${t.price.toFixed(2)}</td><td>${t.shares}</td><td>${t.profit}</td></tr>`).reverse().join('');
    }
}

document.getElementById('setYearBtn').addEventListener('click', () => {
    const y = document.getElementById('quickYearInput').value;
    document.getElementById('startDate').value = `${y}-01-01`;
    document.getElementById('endDate').value = `${y}-12-31`;
});

document.getElementById('exportExcelBtn').addEventListener('click', function() {
    if (currentResults.length === 0) { alert('æ²’æœ‰å¯åŒ¯å‡ºçš„æ•¸æ“šï¼'); return; }
    const excelData = currentResults.map((r, i) => ({
        'æ’å': i + 1, 'çŸ­æœŸåƒæ•¸(S)': r.s, 'é•·æœŸåƒæ•¸(L)': r.l, 'åƒæ•¸çµ„åˆ': `${r.s}/${r.l}`,
        'æœ€çµ‚è³‡ç”¢(USD)': r.finalValue.toFixed(2), 'ç¸½å ±é…¬ç‡(%)': r.roi.toFixed(2),
        'äº¤æ˜“æ¬¡æ•¸': r.tradeCount, 'ç²åˆ©äº¤æ˜“': r.winCount, 'è™§æäº¤æ˜“': r.lossCount,
        'ç¸½ç²åˆ©(USD)': r.totalProfit.toFixed(2), 'ç¸½è™§æ(USD)': r.totalLoss.toFixed(2),
        'å‹ç‡(%)': ((r.winCount / (r.winCount + r.lossCount || 1)) * 100).toFixed(1),
        'é»ƒé‡‘äº¤å‰æ¬¡æ•¸': r.goldenCount, 'æ­»äº¡äº¤å‰æ¬¡æ•¸': r.deathCount
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(excelData);
    ws['!cols'] = [{wch:8},{wch:10},{wch:10},{wch:12},{wch:15},{wch:12},{wch:10},{wch:10},{wch:10},{wch:15},{wch:15},{wch:10},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws, "åƒæ•¸æ’å");
    const stockName = document.getElementById('stockSelect').value || 'Stock';
    const maType = document.getElementById('maType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const fileName = `${stockName}_${maType}_æ’å_${startDate}_to_${endDate}.xlsx`;
    XLSX.writeFile(wb, fileName);
    alert(`Excelæª”æ¡ˆå·²åŒ¯å‡ºï¼š${fileName}`);
});

document.getElementById('runLocateBtn').addEventListener('click', function() {
    if (lockedS === null) { alert("è«‹å…ˆé¸å–ä¸€çµ„åƒæ•¸é€²è¡Œé–å®šï¼"); return; }
    document.getElementById('loader').classList.remove('d-none');
    const maxP = parseInt(document.getElementById('maxP').value);
    const startKey = toDateKey(document.getElementById('startDate').value);
    const endKey = toDateKey(document.getElementById('endDate').value);
    const initCap = parseFloat(document.getElementById('initCapitalInput').value), commRate = parseFloat(document.getElementById('commRateInput').value);

    setTimeout(() => {
        let startIdx = -1, endIdx = -1;
        for (let i = 0; i < fullDates.length; i++) {
            const key = toDateKey(fullDates[i]);
            if (startIdx === -1 && key >= startKey) startIdx = i;
            if (key <= endKey) endIdx = i;
        }
        let allResults = [];
        for (let s = 1; s <= maxP; s++) {
            for (let l = 1; l <= maxP; l++) {
                allResults.push(runBacktest(startIdx, endIdx, s, l, initCap, commRate));
            }
        }
        allResults.sort(customSort);
        const rankIdx = allResults.findIndex(r => r.s === lockedS && r.l === lockedL);
        const myRes = allResults[rankIdx];
        if (!myRes) {
            alert(`åœ¨æ–°çš„ç¯„åœå…§æ‰¾ä¸åˆ°åƒæ•¸çµ„åˆ ${lockedS}/${lockedL}`);
            document.getElementById('loader').classList.add('d-none');
            return;
        }
        updateDisplay(myRes, startIdx, endIdx);
        const year = document.getElementById('startDate').value.split('-')[0];
        const winRate = ((myRes.winCount / (myRes.winCount + myRes.lossCount || 1)) * 100).toFixed(1);
        const newRow = `<tr><td>${year}</td><td><b>${lockedS}/${lockedL}</b></td><td><span class="badge ${rankIdx < 50 ? 'bg-success' : 'bg-danger'}">ç¬¬ ${rankIdx + 1} å</span></td><td>${myRes.roi.toFixed(2)}%</td><td>$${myRes.finalValue.toFixed(2)}</td><td>${myRes.tradeCount}</td><td>${winRate}%</td></tr>`;
        document.querySelector('#performanceLogTable tbody').insertAdjacentHTML('afterbegin', newRow);
        document.getElementById('loader').classList.add('d-none');
    }, 100);
});

document.getElementById('manualApplyBtn').addEventListener('click', function() {
    const s = parseInt(document.getElementById('manualS').value);
    const l = parseInt(document.getElementById('manualL').value);
    if (isNaN(s) || isNaN(l)) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ï¼"); return; }
    if (Object.keys(allMA).length === 0) { alert("è«‹å…ˆé»æ“Šã€Œé–‹å§‹æš´åŠ›ç ´è§£æœå°‹ã€ä»¥é ç®—æ•¸æ“šï¼"); return; }
    if (!allMA[s] || !allMA[l]) { alert("è©²åƒæ•¸å°šæœªè¨ˆç®—ï¼Œè«‹æ“´å¤§æœå°‹ç¯„åœæˆ–é‡æ–°é‹ç®—ï¼"); return; }
    const startKey = toDateKey(document.getElementById('startDate').value);
    const endKey = toDateKey(document.getElementById('endDate').value);
    const initCap = parseFloat(document.getElementById('initCapitalInput').value), commRate = parseFloat(document.getElementById('commRateInput').value);
    let startIdx = -1, endIdx = -1;
    for (let i = 0; i < fullDates.length; i++) {
        const key = toDateKey(fullDates[i]);
        if (startIdx === -1 && key >= startKey) startIdx = i;
        if (key <= endKey) endIdx = i;
    }
    const res = runBacktest(startIdx, endIdx, s, l, initCap, commRate);
    selectRank(null, res, startIdx, endIdx);
    console.clear();
    console.log(`%cğŸ•µï¸ è‡ªå‹•è§¸ç™¼åµéŒ¯ï¼š[S=${s} / L=${l}]`, "color: cyan; font-weight: bold; font-size: 14px;");
    debugStrategyDetail_V2(s, l);
});

function debugStrategyDetail_V2(s, l) {
    if (!fullPrices || fullPrices.length === 0) { console.error("ç„¡æ•¸æ“š"); return; }
    if (s === l) {
        console.log(`%câš ï¸ S=L (${s})ï¼Œç„¡äº¤æ˜“`, "color: orange; font-weight: bold; font-size: 14px;");
        return;
    }
    const initCap = parseFloat(document.getElementById('initCapitalInput').value) || 10000;
    const commRate = parseFloat(document.getElementById('commRateInput').value) || 0.0008;
    const startKey = toDateKey(document.getElementById('startDate').value);
    const endKey = toDateKey(document.getElementById('endDate').value);
    let startIdx = -1, endIdx = -1;
    for (let i = 0; i < fullDates.length; i++) {
        const key = toDateKey(fullDates[i]);
        if (startIdx === -1 && key >= startKey) startIdx = i;
        if (key <= endKey) endIdx = i;
    }
    const maS = allMA[s], maL = allMA[l];
    let cash = initCap, shares = 0, hasPosition = false, firstBuyCost = 0;
    console.log(`æ—¥æœŸ\t\tåƒ¹æ ¼\tS(${s})\tL(${l})\tå‹•ä½œ\tè‚¡æ•¸\tæç›Š`);
    for (let i = startIdx; i < endIdx; i++) {
        if (i <= 0) continue;
        const price = fullPrices[i];
        if (!price) continue;
        const prevS = maS[i-1], currS = maS[i], prevL = maL[i-1], currL = maL[i];
        if (currS === null || currL === null || prevS === null || prevL === null) continue;
        if (prevS < prevL && currS >= currL && !hasPosition) {
            const buyPrice = price * (1 + commRate);
            shares = Math.floor(cash / buyPrice);
            if (shares > 0) {
                const cost = shares * buyPrice;
                cash -= cost; firstBuyCost = cost; hasPosition = true;
                console.log(`%c${fullDates[i]}\t$${price.toFixed(2)}\t${currS.toFixed(2)}\t${currL.toFixed(2)}\tğŸŸ¢è²·\t${shares}\t$${cash.toFixed(2)}`, "color: #4caf50");
            }
        } else if (prevS > prevL && currS <= currL && hasPosition) {
            const sellPrice = price * (1 - commRate);
            const revenue = shares * sellPrice;
            const profit = revenue - firstBuyCost;
            cash += revenue; shares = 0; hasPosition = false;
            console.log(`%c${fullDates[i]}\t$${price.toFixed(2)}\t${currS.toFixed(2)}\t${currL.toFixed(2)}\tğŸ”´è³£\t---\t$${profit.toFixed(2)}`, profit > 0 ? "color: #f44336" : "color: red; font-weight: bold");
        }
    }
    if (hasPosition) {
        const lastPrice = fullPrices[endIdx];
        const revenue = shares * lastPrice * (1 - commRate);
        const profit = revenue - firstBuyCost;
        cash += revenue;
        console.log(`%c${fullDates[endIdx]}\t$${lastPrice.toFixed(2)}\t--\t--\tğŸ”šæ¸…å€‰\t---\t$${profit.toFixed(2)}`, "color: orange");
    }
    console.log(`æœ€çµ‚è³‡ç”¢: $${cash.toFixed(2)}, ç²åˆ©: $${(cash - initCap).toFixed(2)}`);
}
</script>
</body>
</html>